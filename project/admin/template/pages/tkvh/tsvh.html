
<!-- Matter -->
<!--div class="matter"-->
<div class="container">
	<div class="row">
					<div class="col-sm-3">
						<div class="widget" id="last_instant">
							<div class="widget-head">
								<div class="pull-left">Tạo phiếu xử lý sự cố <span class="instant26" ></span></div>
								<div class="widget-icons pull-right">
									<a href="#" class="wminimize"><i class="fa fa-chevron-up"></i></a> 
									<a href="#" class="wclose"><i class="fa fa-times"></i></a>
								</div>  
								<div class="clearfix"></div>
							</div>
							<div class="widget-content">
									<div class="container">
										<div class="row" style="margin-top:10px;margin-left:-10px">
											<form class="form-horizontal" role="form" method="post" action="#">
												
											<div class="form-group">
												<label for="firstName" class="col-sm-3 control-label-rtl">Nhà máy</label>
												<div class="col-sm-3">
													<select class="chosen" style="width:200px;" id="substation">
													</select>
												</div>
											</div>
											
											<div class="form-group">
												<label for="firstName" class="col-sm-3 control-label-rtl">Công tơ</label>
												<div class="col-sm-3">
													<select class="chosen" style="width:200px;" id="meter">
													<option value="999"> Tất cả </option>
													</select>													
												</div>
											</div>											
											 
											<div class="form-group">
												<label for="firstName" class="col-sm-3 control-label-rtl">Sự cố</label>
												<div class="col-sm-6">
													<select class="chosen" style="width:200px;" placeholder="Chọn loại sự cố" id="incident">
													</select>
												</div>
											</div>	

											<div class="form-group">
												<label for="firstName" class="col-sm-3 control-label-rtl" >Nguyên nhân</label>
												<div class="col-sm-6">
													<select class="chosen" style="width:200px;" id="cause_incident">
															
													</select>
												</div>
											</div>
											
											<div class="form-group">
												<label for="lastName" class="col-sm-3 control-label-rtl">Ghi chú</label>
												<div class="col-sm-8">
												<textarea class="form-control" rows="3" id="comment"></textarea>
												</div>
											</div>
											
											<div class="form-group">
												<label for="lastName" class="col-sm-3 control-label-rtl">Xử lý ban đầu</label>
												<div class="col-sm-8">
												<textarea class="form-control" rows="3" id="process" ></textarea>
												</div>
											</div>
											 
											<div class="form-group">
												<label for="firstName" class="col-sm-3 control-label-rtl">Lập phiếu</label>
												<div class="col-sm-8">
												<input type="text" name="lastName" class="form-control" id="current_user" placeholder="Tên người vận hành" disabled >
												</div>
											</div>	
											<div >
												<span class="btn btn-primary addnew_btn pull-right" style="margin: 5px;" id="create_incident_process"> Tạo phiếu </span> 
											</div>
											</form>
										 
										</div><!-- end for class "row" -->
										</div><!-- end for class "container" -->
							</div>

						</div>
						
						
					</div>
					<div class="col-md-5">
						<ul id="myTab" class="nav nav-tabs" style="margin-top:5px; display:; ">
							<li class="active tab_online" id="tab_process"><a href="#process_incident" data-toggle="tab">Phiếu đang xử lý </a> </li>
							<li class="tab_message" id="tab_finish"><a href="#finish_incident" data-toggle="tab">Phiếu đã hoàn thành xử lý</a></li>					
						</ul>
						<div id="myTabContent" class="tab-content">
							<div class="tab-pane fade in active process_incident" id="process_incident">
								<div class="widget bblue_icon" >
									<div class="widget-content">
										<div class="table-responsive">
											<table class="table table-striped table-bordered table-hover" style="">
												<thead>
													<tr>
													  <th>Stt</th>
													  <th>Mã </th>
													  <th>Tên nhà máy</th>
													  <th>Serial Meter</th>
													  <th>TG lập phiếu</th>
													  <th>Người lập</th>	
											  
													</tr>
												</thead>
												<tbody class="tbody-content" >                                                       
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
							
							<div class="tab-pane fade  finish_incident" id="finish_incident">
								<div class="widget bblue_icon" >
									<div class="widget-content">
										<div class="table-responsive">
											<table class="table table-striped table-bordered table-hover" style="">
												<thead>
													<tr>
													  <th>Stt</th>
													  <th>Mã </th>
													  <th>Tên nhà máy</th>
													  <th>Serial Meter</th>
													  <th>TG lập phiếu</th>
													  <th>Người lập</th>	
											  
													</tr>
												</thead>
												<tbody class="tbody-content-finish" >                                                       
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
							
						</div>
					</div>
					
					<div class="col-md-4">
						<div class="container">
							<div class="row">					
								<div class="widget">
									<div class="widget-head">
										<div class="pull-left">Chi tiết phiếu xử lý sự cố <span class="instant26" ></span></div>
										<div class="widget-icons pull-right">
											<a href="#" class="wminimize"><i class="fa fa-chevron-up"></i></a> 
											<a href="#" class="wclose"><i class="fa fa-times"></i></a>
										</div>  
										<div class="clearfix"></div>
									</div>
									<div class="widget-content">
										<div class="widget-foot" >	
											<span style="font-weight:bold;">1. Thông tin chung</span>	
											<span id="status_incident"  class="label" style="margin-left:10px;"></span>
										</div>									
										<div class="table-responsive">
											<table class="table table-striped table-bordered table-hover" style="">
												<thead>
													<th> Các thành phần</th>
													<th> Nội dung chi tiết</th>
												</thead>
												<tbody  > 
													<tr>
														<td> Mã phiếu</td>
														<td id="id_record" style="color:#346C9B; font-weight:bold;"> </td>											
													</tr>
													<tr>
														<td> Nhà máy</td>
														<td id="namesub" style="color:#346C9B; font-weight:bold;"> </td>											
													</tr>
													<tr>
														<td> Công tơ</td>
														<td id="serial_meter" style="color:#346C9B; font-weight:bold;"> </td>											
													</tr>
													<tr>
														<td> Loại sự cố</td>
														<td id="name_incident" style="color:#346C9B; font-weight:bold;"> </td>											
													</tr>
													<tr>
														<td> Nguyên nhân chính</td>
														<td id="name_cause" style="color:#346C9B; font-weight:bold;"> </td>											
													</tr>	
													<tr>
														<td> Ghi chú</td>
														<td id="note_incident" style="color:#346C9B; font-weight:bold;"> </td>											
													</tr>
													<tr>
														<td> Người lập</td>
														<td id="name_user_create" style="color:#346C9B; font-weight:bold;"> </td>											
													</tr>
													<tr>
														<td> Thời gian lập</td>
														<td id="time_incident" style="color:#346C9B; font-weight:bold;"> </td>											
													</tr>											
												</tbody>
											</table>
										</div>
										<div class="widget-foot" >	
											<span style="font-weight:bold;">2. Lịch sử xử lý sự cố</span>	
										</div>	
										<div class="table-responsive">
											<table class="table table-striped table-bordered table-hover" style="">
												<thead>
													<th> Stt</th>										
													<th> Nội dung</th>
													<th> Thời gian </th>
													<th> Người xử lý</th>											
												</thead>
												<tbody class="history_process_body"> 
											
												</tbody>
											</table>
										</div>	
										<div class="widget-foot process_update_textarea" >	
											<span style="font-weight:bold;">3. Tiếp tục cập nhật quá trình xử lý</span>	
										</div>	
										<div class="table-responsive process_update_textarea">
											<textarea class="form-control" rows="3" id="content_process_update"></textarea>
											<span class="btn btn-primary pull-left" style="margin: 5px;" id="update_process"> Tiếp tục cập nhật </span> 
											<span class="btn btn-success pull-right" style="margin: 5px;" id="finish_process"> Hoàn thành xử lý</span> 
										</div>	
							
									</div>

								</div>
							</div>
						</div>	
					</div>
	</div>
</div>
<script src="js/jquery-ui.min.js"></script> <!-- jQuery UI -->
<script src="js/bootstrap-datetimepicker.min.js"></script> <!-- Date picker -->
<script src="js/custom.js"></script> 
<script src="js/themes/sand-signika.js"></script>

<script src="js/choosen/chosen.jquery.min.js"></script> <!-- Custom codes -->
<script src="js/choosen/chosen.proto.min.js"></script> <!-- Custom codes -->

<!-- Menu left + content Page 1 -->
<script>
apilink='http://mdms.npc.com.vn/mdms2015/admin/apis/';
var obj = {}, obj_update={}, obj_finish={} ;
var manager_incident ='';
var fullname ='';



load_incident_manager();
init_info();


jQuery(document).ready(function(){
	jQuery(".chosen").chosen();
});	
$.ajax({
		url:api_link+'/qluser.php',
		type:"POST",
		data:{userid: userid},
		success:function(data){	

			data=JSON.parse(data);
			fullname= data.full_name;

			document.getElementById("current_user").placeholder = fullname;
			document.getElementById("current_user").value = fullname;
			
		}, error: function(e){
			console.log('e '+e);
		}
	
});




function post_incident_new(){
	objects = JSON.stringify(obj);
	$.ajax({
		url:apilink+'incident_createnew.php',
			type:"POST",
			data:{userid:userid, info:objects},
			success:function(data){
				//console.log(data);
				data = JSON.parse(data);
				//console.log(data);
				showalert_withcallback('Thông báo', data.content, 11000, load_incident_manager);
				//alert (data.content);
			},
			error:function(e){
		          console.log('e '+e);
		      }
	});
	
}


function post_incident_update(){
	objects = JSON.stringify(obj_update);
	$.ajax({
		url:apilink+'incident_process_update.php',
			type:"POST",
			data:{userid:userid, info:objects},
			success:function(data){
				//console.log(data);
				data = JSON.parse(data);
				//console.log(data);
				showalert_withcallback('Thông báo', data.content, 11000, load_incident_manager);
				//alert (data.content);
			},
			error:function(e){
		          console.log('e '+e);
		      }
	});
	
}


function post_incident_finish(){
	objects = JSON.stringify(obj_finish);
	$.ajax({
		url:apilink+'incident_process_finish.php',
			type:"POST",
			data:{userid:userid, info:objects},
			success:function(data){
				//console.log(data);
				data = JSON.parse(data);
				//console.log(data);
				showalert_withcallback('Thông báo', data.content, 11000, load_incident_manager);
				//alert (data.content);
			},
			error:function(e){
		          console.log('e '+e);
		      }
	});
	
}


function load_incident_manager(){
	
	$.ajax({
			url:apilink+'incident_manager.php',
			type:"POST",
			data:{id:userid, token:token},
			success:function(data){
				
				data = JSON.parse(data);
				manager_incident = data;
				
				var html=''; html1='';		
				$.each(data,function(index, value){
					if (value['status_incident']==0){
					html +='<tr class="incident_details" data-idincident="'+value['ID']+'"><td>'+index+'</td><td>'+value['ID']+'</td><td>'+value['namesub']+'</td><td>'+value['serial_meter']+'</td>'+
					'<td>'+value['time_incident']+'</td><td>'+value['name_user_create']+'</td>'+
					'</tr>';
					}
					if (value['status_incident']==1){
					html1 +='<tr class="incident_details" data-idincident="'+value['ID']+'"><td>'+index+'</td><td>'+value['ID']+'</td><td>'+value['namesub']+'</td><td>'+value['serial_meter']+'</td>'+
					'<td>'+value['time_incident']+'</td><td>'+value['name_user_create']+'</td>'+
					'</tr>';
					}					
				});
				$('.tbody-content').html(html);
				$('.tbody-content-finish').html(html1);				
			},
			error:function(e){
		        console.log('e '+e);
		    }
	});
	
}


function init_info(){

	$.ajax({
			
			url:apilink+'incident_information.php',
			type:"POST",
			data:{id:userid, token:token},
			success:function(data){
			//console.log(data);
			data = JSON.parse(data);
				//console.log(data);
				datalength = data.length-1; 
				/* Create the List of Substation from data API */
				$('#substation').empty(); //remove all child nodes
				$.each(data,function(index, value){
					var namepc = value[0]['name_pwc'];
					var idpc = value[0]['id_pwc'];
					var list_sub ='';
					
					$.each(value[1],function(index1, value1){

						var namesub = value1['name_sub'];
						var idsub = value1['id_sub'];
						list_sub += '<option value="'+idsub+'">'+namesub+'</option>';
						
					});	
						//alert(list_sub);	
						var newOption_sub = $('<optgroup label="'+namepc+'">'+list_sub+'</optgroup>');
						$('#substation').append(newOption_sub);
						$('#substation').trigger("chosen:updated");	
					
				});
				
				/* Create the List of Meter from data API and selected from list Substation */
				var select_sub;    
				$("#substation").on('click', function () {
					select_sub = this.value;
				}).change(function() {
					$('#meter').empty();
					select_sub = this.value;
					$.each(data,function(index, value){
						$.each(value[1],function(index1, value1){
							if (parseInt(value1['id_sub']) == parseInt(select_sub)) {
								var html='';
								$.each(value1['meterinfo'],function(index2, value2){

									var serial_meter = value2['serial_meter'];
									html +='<option value="'+serial_meter+'">'+serial_meter+'</option>';	
								});
								html = '<option value="'+999+'"> Tất cả </option>'+html;
								var newOption_meter = $(html);									
								$('#meter').append(newOption_meter);
								$('#meter').trigger("chosen:updated");
							}		
						});
					});
				});
				
				/* Create the List of incident from data API  */
				$('#incident').empty();
				$.each(data[datalength],function(index, value){
						var nameincident = value['name_incident'];
						var idincident = value['id_incident'];
						var newOption_incident = $('<option value="'+idincident+'">'+idincident+'.'+nameincident+'</option>');
						$('#incident').append(newOption_incident);
						$('#incident').trigger("chosen:updated");	

				});
				
				/* *********************END*********************** */				
		
				/* Create the List of Cause_incident from data API  */
				var list_cause ='';
				$('#cause_incident').empty();
				$.each(data[datalength],function(index, value){
					var nameincident = value['name_incident'];
					var idincident = value['id_incident'];
					
					$.each(data[datalength-1],function(index1, value1){
						if (value1['id_incident']==value['id_incident']){
							var namecause = value1['name_cause'];
							var idcause = value1['id_cause'];
							list_cause += '<option value="'+idcause+'">'+ idcause+'.'+namecause+'</option>';					
						}
					});
					list_cause = '<optgroup label="'+nameincident+'">'+list_cause+'</optgroup>';
				});
				list_cause = '<option value="'+100+'"> Nguyên nhân khác có ghi chú </option>'+list_cause;
				var newOption_cause = $(list_cause);
				$('#cause_incident').append(newOption_cause);
				$('#cause_incident').trigger("chosen:updated");	
				/* *********************END*********************** */
				
				/* Create the List Cause of Incident when selected Incident */
				var select_incident;    
				$("#incident").on('click', function () {
					select_incident = this.value;
				}).change(function() {
					$('#cause_incident').empty();
					select_incident = this.value;
					
					$.each(data[datalength-1],function(index1, value1){
						if (parseInt(value1['id_incident']) == parseInt(select_incident)){
							var namecause = value1['name_cause'];
							var idcause = value1['id_cause'];
							var newOption_cause =$('<option value="'+idcause+'">'+ idcause+'.'+namecause+'</option>');
							//alert (newOption_cause);
							$('#cause_incident').append(newOption_cause);
							$('#cause_incident').trigger("chosen:updated");		
						}
					});
				});
				/* *********************END*********************** */
				
				/* Create New Incident Record, Load Manager Incident */
							
				$("#create_incident_process").click(function () {
					obj = {};
					
					obj['id_sub'] = $("#substation").chosen().val();
					obj['serial_meter'] = $("#meter").chosen().val(); 
					obj['id_incident'] = $("#incident").chosen().val();
					obj['id_cause'] = $("#cause_incident").chosen().val();
					obj['note_incident'] = $("#comment").val();
					obj['time_incident'] = Math.floor(Date.now() / 1000); 					
					obj['status_incident'] = 0;
					obj['id_user_create'] = userid;					
					obj['name_user_create'] = $("#current_user").val();
					
					obj['content_process'] = $("#process").val();			
					checksecurity(post_incident_new);
					//load_incident_manager();
					//return false;
				});
				/* *********************END*********************** */
				/* *******************Update Incident Process History************* */
				
				$("#update_process").click(function () {
					obj_update = {};
					
					obj_update['id_incident_code'] = $("#id_record").text();
					obj_update['content_process'] = $("#content_process_update").val();
					obj_update['time_process'] = Math.floor(Date.now() / 1000);
					obj_update['user_process'] = fullname;	
		
					checksecurity(post_incident_update);

				});
				/* *********************************END**************************** */		
		
				/* *******************Finish Incident Process ******************** */
				
				$("#finish_process").click(function () {
					obj_finish = {};
					
					obj_finish['id_incident_code'] = $("#id_record").text();
					obj_finish['content_process'] = $("#content_process_update").val();
					obj_finish['time_process'] = Math.floor(Date.now() / 1000);
					obj_finish['user_process'] = fullname;	
		
					checksecurity(post_incident_finish);

				});
				
				/* *********************************END**************************** */						
			

				/* ****************** Load Incident Detail********************** */
							
				$("tr.incident_details").click(function () {

					var current_incident = $(this).data("idincident");
					$('tr.incident_details').css('background','#FFFFFF');
					$(this).css('background','#BBFC7F');	
					$("#status_incident").removeClass('label-success-plus label-info'); 	
					
					$.each(manager_incident,function(index, value){
						if (parseInt(value['ID']) == parseInt(current_incident)){
							
							if (parseInt(value['status_incident'])==1) {
								$("#status_incident").html('Hoàn thành');
								$("#status_incident").addClass('label-success-plus'); 							
								$(".process_update_textarea").hide(); 
							}else {
								$("#status_incident").html('Đang xử lý');
								$("#status_incident").addClass('label-info');
								$(".process_update_textarea").show();  		
							}			
							
							$("#id_record").html(value['ID']);
							$("#namesub").html(value['namesub']);
							$("#serial_meter").html(value['serial_meter']);
							$("#name_incident").html(value['name_incident']);
							$("#name_cause").html(value['name_cause']);
							$("#note_incident").html(value['note_incident']);
							$("#time_incident").html(value['time_incident']);
							$("#name_user_create").html(value['name_user_create']);
							
							var html='';
							$.each(value['process_history'],function(index1, value1){
								html +='<tr><td>'+index1+'</td><td>'+value1['content_process']+
								'</td><td>'+value1['time_process']+'</td><td>'+value1['user_process']+'</td>'+
								'</tr>';							
							});
							$(".history_process_body").html(html);
						}
					});
					
				});

				/* ************************************** END********************** */
		
	
		
		
			},
			error:function(e){
				console.log('e '+e);
			}
	});

}
		


function checksecurity(callbackfnc){

	var inputcontent =  '<div style="text-align: center;font-size: 16px;font-weight: 500;margin-top: 15px;">Thông báo</div>'+
						'<div style="text-align: center; font-size: 15px;margin-top: 8px;">Bạn hãy nhập mật khẩu xác nhận</div>'+
						'<div style="margin:18px 10px; "><input type="password" id="inputpassword" placeholder="Mật khẩu" style="width: 100%;"></div>'+
						'<div class="btnxacnhaninput btn btn-success" style="margin-left:10px;">Xác nhận</div><div class="btn btn-warning btnhuybo" style="margin-left:20px;">Hủy bỏ</div>';

	if (!$('.inputdialog').length) {

	  var $divbg = $('<div id="inputdialog" class="inputdialog" style="height: 100%;background-color: rgba(0,0,0,0.5);position: fixed;top: 0px;left: 0px;right: 0px;z-index: 10002;"></div>').appendTo('body');

	  var $divcontent = $('<div id="inputdialogcontent" style="position: absolute;left: 50%;top: 50%;transform: translate(-50%, -50%);background-color: rgb(255,255,255);height: 200px;width: 360px;z-index: 10001;border-radius: 5px;padding: 10px;"></div>').appendTo($('#inputdialog'));
	  $('#inputdialogcontent').html(inputcontent);
	  
	  $('#inputpassword').focus();

	}

	  $('.btnhuybo').click(function(){
		  $('#inputdialog').remove();
	  });

	  $('.btnxacnhaninput').click(function(){

		  var pass= $('#inputpassword').val();
		  $.post('http://mdms.npc.com.vn/mdms2015/apis/xacnhanpass.php',{userid:userid,password:pass}, function(data){
			  //alert(data);
			  if (data == 500){
				showalert('Thông báo', 'Lỗi kết nối server, bạn hãy thử lại lần sau!', 11000);
				return false;
			  } else if (data == 404){
				showalert('Thông báo', 'Sai mật khẩu, bạn hãy thử lại lần sau!', 11000);
				return false;
			  } else if (data == 200) {
				//console.log('thanh cong');
				$('#inputdialog').remove();
				if(callbackfnc) {callbackfnc();}
				//replace_chiso(csdauky, cscuoiky);
				return true;

			  }else if (data == 404){
				showalert('Thông báo', 'Xác nhận mật khẩu thất bại!', 11000);
				return false;
			  }
		  });
		return false;
	  });

}
</script>

<style>
	.nav-tabs>li.active>a{
		background: #79A9D1 !important;
		color: white!important;
		font-weight:bold;
	}
	.nav-tabs>li>a: hover {
		color: white!important;
	}
</style>
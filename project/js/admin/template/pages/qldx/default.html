<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <!-- Title and other stuffs -->
  <title>IPP NPC Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content=" thủy điện IPP">
  <meta name="keywords" content="NPC thủy điện IPP">
  <meta name="author" content="NPCIT">
  <!-- Stylesheets -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <!-- Font awesome icon -->
  <link rel="stylesheet" href="css/font-awesome.min.css"> 
  <!-- jQuery UI -->
  <link rel="stylesheet" href="css/jquery-ui.css"> 
  <!-- Data tables -->
  <link rel="stylesheet" href="css/jquery.dataTables.css"> 
  <!-- Main stylesheet -->
  <link href="css/style.css" rel="stylesheet">
  <!-- Widgets stylesheet -->
  <link href="css/widgets.css" rel="stylesheet">
  <!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <![endif]-->
  <!-- Favicon -->
  <link rel="shortcut icon" href="img/favicon/favicon.png">
  <style>
		.nav-tabs>li.active>a{
			background: #79A9D1 !important;
			color: white!important;
			font-weight:bold;
		}
		.nav-tabs>li>a: hover {
			color: white!important;
		}
  </style>
</head>

<body>

<?php echo $modunheader; ?>
<!-- Main content starts -->
<div class="content">

  	<!-- Main bar -->
  	<div class="mainbar" style="margin-left: 0px;">
        <!-- Page heading -->
	    <div class="page-head ">
			<!-- Add tên nhà máy -->
			<h2 class="pull-left name_sub_head" style="padding-right:5px; padding-top: 20px;"></h2>
			<!-- Add vị trí hiện tại của trang -->
			<div class="bread-crumb pull-right label label-primary" style=" position: absolute; top: -10px;right: 15px; margin-top: 0px; color:#FFFFFF">
			  <a style="color:#FFFFFF" ><i class="fa fa-home"></i> Home</a> 
			  <!-- Divider -->
			  <span class="divider" >/</span> 
			  <a class="mainmenu " style="color:#FFFFFF">...</a>
			  <span class="divider">/</span> 
			  <a class="listmenu " style="color:#FFFFFF">...</a>
			</div>
			<!-- Tự động add List toàn bộ các meter thuộc nhà máy khi click nhà máy -->
		    <ul class="page1_meter">                
                                                                                                                             
            </ul> 
			<div class="clearfix"></div>
	    </div>
	    <!-- Page heading ends -->
	    <!-- Matter -->
	    <div class="matter">
			<div class="container">
				<!-- Cột chứa các biểu đồ gồm dòng điện, điện áp, tần số -->
				<div class="row">
					<div class="col-md-6">
						<ul id="myTab" class="nav nav-tabs" style="margin-top:5px; display:; ">
							<li class="active tab_online" id="tab_online"><a href="#online_alert" data-toggle="tab">Cảnh báo Online/Offline nhà máy </a> </li>
							<li class="tab_message" id="tab_message"><a href="#userconfirm_alert" data-toggle="tab">Cảnh báo phản hồi người dùng</a></li>
						</ul>
						<div id="myTabContent" class="tab-content">
							<div class="tab-pane fade in active online_alert" id="online_alert">
								<div class="widget" id="lastinstant">
									
									<div class="widget-content">
										<div class="widget-foot" >			  
											<span class="label label-info" >cảnh báo</span><a style="margin-right:5px;"> Trên 60 phút</a> 
											<span class="label label-warning">cảnh báo</span><a style="margin-right:5px;"> Trên 30 phút</a>
											<span class="label label-success">cảnh báo</span><a> Trên 5 phút</a> 									
											<div class="clearfix"></div> 

										</div>							
										<div class="table-responsive">
											<table class="table table-striped table-bordered table-hover" >
												<thead>
												<tr>
												  <th>Stt</th>
												  <th>Tên điện lực </th>
												  <th>Tên nhà máy</th>
												  <th>TG mất kết nối</th>
												</tr>
												</thead>
												<tbody class="connectionbody">
			
												</tbody>
											</table>
										</div>							
										
									</div>
								</div>	
							</div>
						
							<div class="tab-pane fade userconfirm_alert" id="userconfirm_alert">
								<div class="widget" >
									<div class="widget-head">
										<div class="pull-left">Thông tin chi tiết<span class="instant26"  ></span></div>
										<div class="widget-icons pull-right">
											<a href="#" class="wminimize"><i class="fa fa-chevron-up"></i></a> 
											<a href="#" class="wclose"><i class="fa fa-times"></i></a>
										</div>  
										<div class="clearfix"></div>
									</div>
									<div class="widget-content">
										<div class="table-responsive">
											<table class="table  table-bordered table-hover" >
												<thead>
												<tr>
												  <th>Stt</th>
												  <th>Người gửi </th>
												  <th>Số điện thoại</th>
												  <th>Nội dung</th>										  
												  <th>TG cập nhật</th>

												</tr>
												</thead>
												<tbody class="ykienbody">
			
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>	
						</div>	
					</div>

					<div class="col-md-6">
						<ul id="myTab2" class="nav nav-tabs" style="margin-top:5px; display:; ">
							<li class="active tab_online" id="tab_instant"><a href="#instant_alert" data-toggle="tab">Dữ liệu 15 phút - Instant </a> </li>
							<li class="tab_message" id="tab_curent"><a href="#curent_alert" data-toggle="tab">Dữ liệu 60 phút - Curent</a></li>
							<li class="tab_message" id="tab_profile"><a href="#profile_alert" data-toggle="tab">Phụ tải - Profile</a></li>
							<li class="tab_message" id="tab_h1"><a href="#h1_alert" data-toggle="tab">Chỉ số tháng - H1</a></li>							
						</ul>
						<div id="myTabContent2" class="tab-content">
							<div class="tab-pane fade in active instant_alert" id="instant_alert">					
								<div class="widget" >
								
									<div class="widget-content">
										<div class="widget-foot" >			  
											<span class="label label-info" >cảnh báo</span><a style="margin-right:5px;"> Trên 60 phút</a> 
											<span class="label label-warning">cảnh báo</span><a style="margin-right:5px;"> Trên 40 phút</a>
											<span class="label label-success">cảnh báo</span><a> Trên 20 phút</a> 									
											<div class="clearfix"></div> 

										</div>							
										<div class="table-responsive">
											<table class="table table-striped table-bordered table-hover" >
												<thead>
												<tr>
												  <th>Stt</th>
												  <th>Tên điện lực </th>
												  <th>Tên nhà máy</th>
												  <th>Công tơ</th>
												  <th>TG cập nhật cuối</th>

												</tr>
												</thead>
												<tbody class="instanbody">
			
												</tbody>
											</table>
										</div>							
										
									</div>
								</div>
							</div>
							<div class="tab-pane fade curent_alert" id="curent_alert">
								<div class="widget bblue_icon" >
									<div class="widget-content">
										<div class="widget-foot" >			  
											<span class="label label-info" >cảnh báo</span><a style="margin-right:5px;"> Trên 180 phút</a> 
											<span class="label label-warning">cảnh báo</span><a style="margin-right:5px;"> Trên 120 phút</a>
											<span class="label label-success">cảnh báo</span><a> Trên 60 phút</a> 									
											<div class="clearfix"></div>
										</div>	
										<div class="table-responsive">
											<table class="table table-striped table-bordered table-hover" >
												<thead>
													<tr>
													  <th>Stt</th>
													  <th>Tên điện lực </th>
													  <th>Tên nhà máy</th>
													  <th>Serial Meter</th>
													  <th>TG cập nhật cuối</th>
													</tr>
												</thead>
												<tbody class="currentbody" >										                                                          
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
							<div class="tab-pane fade profile_alert" id="profile_alert">
								<div class="widget bblue_icon" id="last_current">
									<div class="widget-content">
										<div class="widget-foot" >			  
											<span class="label label-info" >cảnh báo</span><a style="margin-right:5px;"> Trên 24 giờ</a> 
											<span class="label label-warning">cảnh báo</span><a style="margin-right:5px;"> Trên 16 giờ</a>
											<span class="label label-success">cảnh báo</span><a> Trên 8 giờ</a> 									
											<div class="clearfix"></div>
										</div>								
										<div class="table-responsive">
											<table class="table table-striped table-bordered table-hover" >
												<thead>
													<tr>
													  <th>Stt</th>
													  <th>Tên điện lực </th>
													  <th>Tên nhà máy</th>
													  <th>Serial Meter</th>
													  <th>TG cập nhật cuối</th>
													</tr>
												</thead>
												<tbody class="profilebody" >										                                                          
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
							<div class="tab-pane fade h1_alert" id="h1_alert">
								<div class="widget bblue_icon" >
									<div class="widget-content">
										<div class="table-responsive">
											<table class="table table-striped table-bordered table-hover" >
												<thead>
													<tr>
													  <th>Stt</th>
													  <th>Tên điện lực </th>
													  <th>Tên nhà máy</th>
													  <th>Serial Meter</th>
													  <th>TG cập nhật cuối</th>
													</tr>
												</thead>
												<tbody class="historybody" >										                                                          
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>						
					</div>
				</div>
				<!-- Dashboard graph ends -->
			</div>
		</div>	
<!-- Content ends -->
<!-- Footer starts -->


<!-- Footer ends -->
<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="fa fa-chevron-up"></i></a></span> 

<script>
	
	check_warning_status();
	/*  
	*	Khởi tạo giá trị ban đầu cho Nhà máy đầu tiên, tên nhà máy đầu tiên, id nhà máy đầu tiên
	*	Mảng menu_left đã được khởi tạo và có giá trị khi load Header
	*/
	var firstsub = menu_left[0][1][0]['id_sub'];
	var firstnamesub = menu_left[0][1][0]['name_sub'];
	
	if (parseInt(crsubid) == 0) {crsubid = firstsub}
	if (crnamesub== '') {crnamesub = firstnamesub}	
	
	/*  
	*	Khởi tạo html cho menuleft theo hàm generate_menuleft trên Header
	*/
	generate_menuleft(menu_left);

	/*  
	*	Action khi click nhà máy thuộc menu left
	*	update lại thông số hiện tại của ID nhà máy, Tên nhà máy khi click
	*  	crmeter='': ????
	*	Gọi hàm page1_meter để thực hiện các thao tác: list meter, vẽ đồ thị, tạo các bảng dữ liệu 
	*	page1_meter : có các tham số crsubid (ID nhà máy hiện tại) và callfrommenuleft (phân biệt khi autoload hoặc click menuleft)
	* 	Add css cho menuleft hiện hữu
	*/
	$(".list_sub > li").click(function(){

		crsubid = $(this).data('id');
		crnamesub = $(this).data('name');
		crmeter == '';	//???? update first crmeter of each sub choose
		page1_meter(crsubid, 'callfrommenuleft');
		$(".list_sub > li").removeClass('current');
		$(this).addClass('current');
	});
	/*  
	*	Action Toggle khi click Menuleft
	*	Add css open cho các menu click hoặc ngược lại
	*/
	
	$(".has_sub > a").click(function(e){
		e.preventDefault();
		var menu_li = $(this).parent("li");
		var menu_ul = $(this).next("ul");

		if(menu_li.hasClass("open")){
			menu_ul.slideUp(350);
			menu_li.removeClass("open")
		}
		else{
			$("#nav > li > ul").slideUp(350);
			$("#nav > li").removeClass("open");
			menu_ul.slideDown(350);
			menu_li.addClass("open");
		}
	});

	/*  
	*	Function load dữ liệu cho toàn bộ trang
	*/

	setInterval(function(){ check_warning_status(); }, 60000);
	
	function check_warning_status(){
		$.ajax({
		/*  
		*	Lấy thông tin toàn bộ công tơ trong nhà máy
		*/
			url:'http://mdms.npc.com.vn/mdms2015/admin/apis/systemanalytics_instantvalue.php',
			type:"POST",
			data:{},
			success:function(data){
				data = JSON.parse(data);
				console.log(data.datainstan);
				var htmlinstan = '', htmlcurrent = '', htmlprofile='', htmlhistory='', htmlykien='', htmlconnect='', only_sub='' ;			
				
				if (data.listoffline.length == 0){
					htmlconnect ='<tr ><td colspan="4" style="text-align:center; font-weight:bold; color: Blue;"> Không có dữ liệu cảnh báo</td></tr>' ;
					} else {
					var stt =1;
					$.each(data.listoffline,function(index, value){
						
						if (only_sub != value.name_sub){ 
							htmlconnect += '<tr ><td class=" " >'+stt+'</td>'+
											'<td > '+value.name_pwc+'</td>'+
											'<td >'+value.name_sub+'</td>'+
											'<td style="font-weight: bold; color:'+value.status_warning+'" >'+value.datetime_format+'</td></tr>';	
							only_sub = value.name_sub;	
							stt ++ ;		
						}
						
					});	
				}
				$('.connectionbody').html(htmlconnect);

				
				$.each(data.datainstan,function(index, value){
					htmlinstan += '<tr ><td class=" " >'+index+'</td>'+
									'<td > '+value.name_pwc+'</td>'+
									'<td >'+value.name_sub+'</td>'+
									'<td >'+value.serial_meter+'</td>'+
									'<td style="font-weight: bold; color:'+value.status_warning+'">'+value.last_update+'</td></tr>';
				});	
				$('.instanbody').html(htmlinstan);
				
				$.each(data.datacurrent,function(index, value){
					//alert (data.datacurrent.length);
					htmlcurrent += '<tr ><td class=" " >'+index+'</td>'+
									'<td > '+value.name_pwc+'</td>'+
									'<td >'+value.name_sub+'</td>'+
									'<td >'+value.serial_meter+'</td>'+
									'<td  style="font-weight: bold; color:'+value.status_warning+'">'+value.last_update+'</td></tr>';
				});	
				$('.currentbody').html(htmlcurrent);
				
				
				if (data.dataprofile.length == 0){
					htmlprofile ='<tr ><td colspan="5" style="text-align:center; font-weight:bold; color: Blue;"> Không có dữ liệu cảnh báo</td></tr>' ;
					} else {
					$.each(data.dataprofile,function(index, value){
					htmlprofile += '<tr ><td class=" " >'+index+'</td>'+
									'<td > '+value.name_pwc+'</td>'+
									'<td >'+value.name_sub+'</td>'+
									'<td >'+value.serial_meter+'</td>'+
									'<td  style="font-weight: bold; color:'+value.status_warning+'">'+value.last_update+'</td></tr>';
										
					});	
				}
				$('.profilebody').html(htmlprofile);
				
				if (data.datahistory.length == 0){
					htmlhistory ='<tr ><td colspan="5" style="text-align:center; font-weight:bold; color: Blue;"> Không có dữ liệu cảnh báo</td></tr>' ;
					} else {
					$.each(data.datahistory,function(index, value){
					htmlhistory += '<tr ><td class=" " >'+index+'</td>'+
									'<td > '+value.name_pwc+'</td>'+
									'<td >'+value.name_sub+'</td>'+
									'<td >'+value.serial_meter+'</td>'+
									'<td  style="font-weight: bold; color:'+value.status_warning+'">'+value.last_update+'</td></tr>';
										
					});	
				}
				$('.historybody').html(htmlhistory);
				
				if (data.dataykien.length == 0){
					htmlhistory ='<tr ><td colspan="5" style="text-align:center; font-weight:bold; color: Blue;"> Không có dữ liệu cảnh báo</td></tr>' ;
					} else {
					$.each(data.dataykien,function(index, value){
					htmlykien += '<tr href="#" data-toggle="tooltip" title="'+value.content+' "  ><td class=" " >'+index+'</td>'+
									'<td > '+value.fullname+'</td>'+
									'<td >'+value.phone+'</td>'+
									'<td  >'+value.short_content+'...</td>'+									
									'<td  style="font-weight: bold; color:'+value.status_warning+'">'+value.time+'</td></tr>';
										
					});	
				}
				$('.ykienbody').html(htmlykien);	



				
				
			}, error: function(e){
				console.log('e '+e);
			}
		
		}); 
	}
	

	/*	
	*	Gọi hàm page1_meter tự động thực hiện của trang khi F5 hoặc đăng nhập mới
	*/

	page1_meter(crsubid);

	/*	
	*	Usage:
	*	Hàm chart gọi api page1_meter_chart.php trả về giá trị mảng về thông số để vẽ đồ thị, mảng thông số chỉ số, mảng thông số vận hành
	*/
	function chart(serial){
		$('.showmeter').text(crmeter);
		dt =[], dt0 =[], dt1 =[];
		$.ajax({
				url:api_link+'/page1_meter_chart.php',
				type:"POST",
				data:{serial: serial},
				success:function(data){
					temp = JSON.parse(data);
					dt=temp.dongdien;
					drawchart(temp.dongdien,$('#container1'),'I','Dòng điện (A)');
					drawchart(temp.dienap,$('#container2'),'U','Điện áp (V)');
					drawchart(temp.tanso,$('#container3'),'F','Tần số (F)');		
					apply_thongso(temp.thongso);
					apply_chiso(temp.chiso);				
				}, error: function(e){
					console.log('e '+e);
				}
			
		}); 
	}
	
	/*	
	*	Usage:
	*	Gán giá trị mảng thông số vận hành vào html có bảng thông số: class là instant
	* 	Bảng này phần đơn vị đã được tính toán trên api
	*/	
	
	function apply_thongso(data){
		var i =1;
		for (var key in data){
			var ttt = '#last_instant .instant'+i;
			$(ttt).html(data[key]);
			i++;
		}
	}
	/*	
	*	Usage:
	*	Gán giá trị mảng thông số chỉ số vào html có bảng chỉ số: class là current
	*	Phần đơn vị tính được lấy từ api để điền vào class donvi_chiso
	*/			
	function apply_chiso(data){
		var i =1;
		for (var key in data){
			var temp1 = '#last_current .current'+i;
			$(temp1).html(data[key]);
			i++;
		}
		
		$('.donvi_chiso').html(data["unit_meter"]);
	}
	/*	
	*	Usage:
	*	Vẽ đồ thị theo các tham số được truyền vào gồm:
	*	mảng giá trị dt
	*	id của html element cần gán đồ thị $this
	* 	nameunit đơn vị của đồ thị : Ampe, Voltage, Frequency
	*	namegraph tên đồ thị cần vẽ
	*/			
	
	function drawchart(dt,$this,nameunit,namegraph){
	    Highcharts.setOptions({
			global: {
				useUTC: false
			}
		});
		$this.highcharts({
			chart: {
					// Edit chart spacing
					spacingBottom: 5,
					spacingTop: 15,
					spacingLeft: 0,
					spacingRight: 5,

					// Explicitly tell the width and height of a chart
					width: null,
					height: null
			},			
			title: {
				text:'',
			},
			global: { 
				//useUTC: false
			},
			navigation: {
				buttonOptions: {
					verticalAlign: 'bottom',
					y: -15
				}
			},
			xAxis: {
				type: 'datetime',
				tickInterval: 3600 * 600, // one hour
				tickWidth: 0,
				gridLineWidth: 1,
				
			},
			yAxis: [{ //--- Primary yAxis
				title: {
					text: namegraph,
				},
				labels: {
					align: 'right',
					x: 0,
					y: 0
				}
			}],
			tooltip: {						
				shared: true,
				crosshairs: true,
				borderColor: '#058DC7',
			},
			series: [{
				name: nameunit+'phaA',
				color: '#E43632', 
				data: dt[0]
			},
			{
				name: nameunit+'phaB',
				color: '#AA7301',
				data: dt[1]
			},
			{
				name: nameunit+'phaC',
				color: '#2E7000',
				data: dt[2]
				}
			]
		});	
	}
	
$(document).ready(function(){
	$('[data-toggle="tooltip"]').tooltip();   
});
</script>

<script src="js/highstock.js"></script>  <!-- highstock -->
<script src="js/modules/exporting.js"></script>  <!-- highstock export -->
<script src="js/bootstrap.min.js"></script> <!-- Bootstrap -->
<!--<script src="js/jquery.slimscroll.min.js"></script>  jQuery Slim Scroll 
<script src="js/jquery.onoff.min.js"></script> Bootstrap Toggle -->
<script src="js/custom.js"></script> <!-- Custom codes -->
<!-- Script for this page -->
</body>
</html>